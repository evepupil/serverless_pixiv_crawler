# Pixiv Crawler - Cloudflare Workers ç‰ˆæœ¬

## ğŸš€ **åŠŸèƒ½ç‰¹æ€§**

### **æ ¸å¿ƒåŠŸèƒ½**
- âœ… **çœŸå® Pixiv çˆ¬è™«** - ä½¿ç”¨çº¯ Web API è¿›è¡Œçˆ¬å–
- âœ… **HTML è§£æ** - æ™ºèƒ½æå– PIDs å’Œæ’åä¿¡æ¯
- âœ… **å¤šç§ PID æå–æ–¹æ³•** - ä¸»æ–¹æ³•å’Œå¤‡ç”¨æ–¹æ³•ç¡®ä¿æˆåŠŸç‡
- âœ… **æ’è¡Œæ¦œçˆ¬å–** - æ—¥æ¦œã€å‘¨æ¦œã€æœˆæ¦œå®Œæ•´æ”¯æŒ
- âœ… **é¦–é¡µæ¨èçˆ¬å–** - è·å–é¦–é¡µæ¨èä½œå“
- âœ… **å• PID çˆ¬å–** - ä»æŒ‡å®šä½œå“è·å–ç›¸å…³æ¨è
- âœ… **æ•°æ®åº“å†™å…¥** - ç›´æ¥å†™å…¥ Supabase æ•°æ®åº“
- âœ… **æ¨¡å—åŒ–æ¶æ„** - å¤ç”¨ Vercel ç‰ˆæœ¬çš„ä»£ç ç»“æ„

### **æŠ€æœ¯ç‰¹ç‚¹**
- ğŸŒ **çº¯ Web API** - ä¸ä¾èµ– Node.js æ¨¡å—ï¼Œå®Œå…¨å…¼å®¹ Cloudflare Workers
- ğŸ”’ **å®‰å…¨è®¤è¯** - æ”¯æŒ Supabase æ–°ç‰ˆ API Keys
- ğŸ“Š **å®æ—¶ç»Ÿè®¡** - æä¾›çˆ¬å–çŠ¶æ€å’Œæ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
- ğŸš« **æ™ºèƒ½è¿‡æ»¤** - åªåœ¨æˆåŠŸçˆ¬å–æ•°æ®æ—¶å†™å…¥æ•°æ®åº“
- ğŸ“ **è¯¦ç»†æ—¥å¿—** - å®Œæ•´çš„çˆ¬å–è¿‡ç¨‹æ—¥å¿—è®°å½•

## ğŸ—ï¸ **æ¶æ„è®¾è®¡**

### **ç›®å½•ç»“æ„**
```
cf_worker_pixiv_crawler/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/           # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ services/        # çˆ¬è™«æœåŠ¡
â”‚   â”œâ”€â”€ database/        # æ•°æ®åº“æœåŠ¡
â”‚   â””â”€â”€ config/          # é…ç½®æœåŠ¡
â”œâ”€â”€ cf-worker.ts         # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ wrangler.toml        # Cloudflare é…ç½®
â””â”€â”€ README.md            # è¯´æ˜æ–‡æ¡£
```

### **æ¨¡å—è¯´æ˜**
- **`PixivCrawler`** - æ ¸å¿ƒçˆ¬è™«é€»è¾‘ï¼Œå¤ç”¨ Vercel ç‰ˆæœ¬æ¶æ„
- **`SupabaseService`** - æ•°æ®åº“æ“ä½œï¼Œç›´æ¥è°ƒç”¨ REST API
- **ç±»å‹ç³»ç»Ÿ** - å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- **é…ç½®ç®¡ç†** - ç»Ÿä¸€çš„é…ç½®å’Œè¯·æ±‚å¤´ç®¡ç†

## ğŸ”§ **API ç«¯ç‚¹**

### **GET è¯·æ±‚**
- `/?action=status` - æ£€æŸ¥ API çŠ¶æ€å’Œæ•°æ®åº“ç»Ÿè®¡
- `/?action=env-check` - æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
- `/?action=daily` - çˆ¬å–æ—¥æ’è¡Œæ¦œå¹¶ä¿å­˜åˆ°æ•°æ®åº“
- `/?action=weekly` - çˆ¬å–å‘¨æ’è¡Œæ¦œå¹¶ä¿å­˜åˆ°æ•°æ®åº“
- `/?action=monthly` - çˆ¬å–æœˆæ’è¡Œæ¦œå¹¶ä¿å­˜åˆ°æ•°æ®åº“
- `/?action=home` - çˆ¬å–é¦–é¡µæ¨èå¹¶ä¿å­˜åˆ°æ•°æ®åº“

### **POST è¯·æ±‚**
- `/` - ä»æŒ‡å®š PID çˆ¬å–ç›¸å…³ä½œå“å¹¶ä¿å­˜åˆ°æ•°æ®åº“

## ğŸ“Š **å“åº”æ ¼å¼**

### **æˆåŠŸå“åº”ç¤ºä¾‹**
```json
{
  "message": "Monthly ranking crawl completed and saved to database",
  "result": {
    "body": {
      "rankings": [
        {"pid": "123456", "rank": 1, "crawl_time": "2025-08-11T17:11:11.050Z"}
      ]
    },
    "error": false
  },
  "taskId": "monthly_1754932271050",
  "timestamp": "2025-08-11T17:11:11.050Z",
  "databaseWrite": "success",
  "rankingsCount": 1
}
```

### **å¤±è´¥å“åº”ç¤ºä¾‹**
```json
{
  "message": "Monthly ranking crawl failed - no data extracted",
  "result": {"body": {"rankings": []}, "error": true},
  "taskId": "monthly_1754932271050",
  "timestamp": "2025-08-11T17:11:11.050Z",
  "databaseWrite": "skipped",
  "error": "No rankings data to save"
}
```

## âš™ï¸ **ç¯å¢ƒå˜é‡**

### **å¿…éœ€å˜é‡**
- `SUPABASE_URL` - Supabase é¡¹ç›® URL
- `SUPABASE_SERVICE_ROLE_KEY` - Supabase æœåŠ¡è§’è‰²å¯†é’¥
- `PIXIV_COOKIE` - Pixiv ç½‘ç«™ Cookie

### **å¯é€‰å˜é‡**
- `PIXIV_REFERER` - Pixiv è¯·æ±‚å¼•ç”¨é¡µ
- `PIXIV_USER_AGENT` - è‡ªå®šä¹‰ User-Agent

## ğŸš€ **éƒ¨ç½²è¯´æ˜**

### **1. å®‰è£…ä¾èµ–**
```bash
npm install
```

### **2. é…ç½®ç¯å¢ƒå˜é‡**
åœ¨ `wrangler.toml` ä¸­é…ç½®ç¯å¢ƒå˜é‡ï¼Œæˆ–ä½¿ç”¨ `wrangler secret` å‘½ä»¤

### **3. éƒ¨ç½²åˆ° Cloudflare**
```bash
wrangler deploy
```

## ğŸ” **è°ƒè¯•å’Œç›‘æ§**

### **æ—¥å¿—æŸ¥çœ‹**
- æ‰€æœ‰çˆ¬å–è¿‡ç¨‹éƒ½æœ‰è¯¦ç»†çš„ console.log è¾“å‡º
- å¯åœ¨ Cloudflare Workers æ§åˆ¶å°æŸ¥çœ‹å®æ—¶æ—¥å¿—

### **çŠ¶æ€æ£€æŸ¥**
- ä½¿ç”¨ `/?action=status` æ£€æŸ¥ API çŠ¶æ€
- ä½¿ç”¨ `/?action=env-check` éªŒè¯ç¯å¢ƒé…ç½®

### **æ•°æ®åº“éªŒè¯**
- å“åº”ä¸­çš„ `databaseWrite` å­—æ®µæ˜¾ç¤ºæ•°æ®åº“å†™å…¥çŠ¶æ€
- `rankingsCount` æ˜¾ç¤ºå®é™…çˆ¬å–çš„æ•°æ®é‡

## ğŸ†š **ä¸ Vercel ç‰ˆæœ¬å¯¹æ¯”**

| ç‰¹æ€§ | Vercel ç‰ˆæœ¬ | CF Workers ç‰ˆæœ¬ |
|------|-------------|-----------------|
| æ¶æ„ | å•ä½“æ–‡ä»¶ | æ¨¡å—åŒ–åˆ†ç¦» |
| ä¾èµ– | Node.js æ¨¡å— | çº¯ Web API |
| éƒ¨ç½² | Vercel | Cloudflare Workers |
| å‰ç«¯ | HTML ç•Œé¢ | API æ¥å£ |
| åŠŸèƒ½ | å®Œæ•´åŠŸèƒ½ | æ ¸å¿ƒçˆ¬è™«åŠŸèƒ½ |
| æ•°æ®åº“ | Supabase å®¢æˆ·ç«¯ | ç›´æ¥ REST API |

## ğŸ› **æ•…éšœæ’é™¤**

### **å¸¸è§é—®é¢˜**
1. **çˆ¬å–å¤±è´¥ä½†æ˜¾ç¤ºæˆåŠŸ** - æ£€æŸ¥ `databaseWrite` å­—æ®µ
2. **æ²¡æœ‰æ•°æ®å†™å…¥** - æŸ¥çœ‹ `rankingsCount` æ˜¯å¦ä¸º 0
3. **ç¯å¢ƒå˜é‡é”™è¯¯** - ä½¿ç”¨ `/?action=env-check` éªŒè¯

### **è°ƒè¯•æ­¥éª¤**
1. æ£€æŸ¥ Cloudflare Workers æ—¥å¿—
2. éªŒè¯ç¯å¢ƒå˜é‡é…ç½®
3. æµ‹è¯•å•ä¸ª API ç«¯ç‚¹
4. æ£€æŸ¥ Supabase æ•°æ®åº“æƒé™

## ğŸ“ **æ›´æ–°æ—¥å¿—**

### **v2.0.0** - æ¨¡å—åŒ–é‡æ„
- âœ… é‡æ„ä¸ºæ¨¡å—åŒ–æ¶æ„
- âœ… å¤ç”¨ Vercel ç‰ˆæœ¬ä»£ç ç»“æ„
- âœ… æ”¹è¿› PID æå–æ–¹æ³•
- âœ… æ·»åŠ å¤‡ç”¨æå–ç­–ç•¥
- âœ… æ™ºèƒ½æ•°æ®åº“å†™å…¥æ§åˆ¶
- âœ… è¯¦ç»†çš„å“åº”çŠ¶æ€ä¿¡æ¯

---

**æ³¨æ„**: æ­¤ç‰ˆæœ¬å®Œå…¨å…¼å®¹ Cloudflare Workers ç¯å¢ƒï¼Œä½¿ç”¨çº¯ Web API å®ç°ï¼Œç¡®ä¿åœ¨ CF Workers ä¸­ç¨³å®šè¿è¡Œã€‚